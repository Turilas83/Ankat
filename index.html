<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="msapplication-tap-highlight" content="no" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
	<meta http-equiv="Content-Security-Policy" content="
			default-src 'self' 'unsafe-inline' http://proto387.haaga-helia.fi/ 
			ws://10.213.228.99:3000/
https://mts.googleapis.com https://maps.googleapis.com 
https://maps.gstatic.com  http://code.jquery.com 
https://code.jquery.com https://csi.gstatic.com  https://ssl.gstatic.com gap: data: blob: filesystem: ; 
	" />
	
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
	<script src="https://code.jquery.com/jquery-2.1.4.js" integrity="sha256-siFczlgw4jULnUICcdm9gjQPZkw/YPDqhQ9+nAOScE4="	crossorigin="anonymous"></script>
	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/index.css">
	<title>Sorsasovellus</title>
</head>
<body>

	<div data-role="page" id="loginPage">
		<div data-role="header" id="head">
			<h1>Kirjautuminen</h1>
		</div>
		<div data-role="main" class="ui-content ui-body-a">
		<form id="loginForm">
			<p>
			<label for="name">Nimi:</label>
			<input type="text" name="name" id="username">
			</p>
			<p>
			<label for="pwd">Salasana:</label>
			<input type="password" name="pwd" id="pwd">
			</p>
			<p>
			<input type="button" id="login" class="ui-button" value="kirjaudu">
			</p>
			</form>
		</div>
		<div data-role="footer" id="loginFooter">
			<h1>Sorsasovellus</h1>
		</div>
	</div>

	<div data-role="page" id="addDuck">
		<div data-role="header" id="addDuckHead">
			<h1>Havainto</h1>
			<h1 id="loggedIn"></h1>
		</div>
	<div data-role="main" class="ui-content ui-body-a">
	<form id="lisaaLomake">
	  <p>
		<label for="species">Sorsalaji:</label>
		<input type="text" name="species" id="species">
      </p>	
      <p>
        <label for="description">Kuvaus:</label>
		<input type="text" name="description" id="description">
      </p>
      <p>
		<label for="date">Päivä:</label>
		<input type="text" name="date" id="date">	
      </p>
      <p>
        <label for="count">Määrä:</label>
        <input type="number" name="count" id="count">
      </p>
      <p>
        <label for="location">Sijainti:</label>
		<div id="mapLocation" style="height:300px"></div> 
      </p>
	  <p>
		<input type="button" id="add" class="ui-button" value="Lisää havainto">
		<input type="button" id="showDucks" class="ui-button" value="Näytä havainnot">
	  </p>
	</form>	
		<!--<p>
			<ul data-role="listview" id="duckList" data-inset="true"></ul>
		</p>
   		</div>
		<div data-role="popup" id="popup_vahvistus">
			<div data-role="content">
				<h3 id="poistoTxt"></h3>
				<a class="ui-btn ui-corner-all" data-rel="back">Peruuta</a>
				<a class="ui-btn ui-corner-all" id="vahvistaPoisto" >Vahvista</a>
			</div>-->
	</div> 
		<div data-role="footer" id="addDuckFooter">
			<h1>Sorsasovellus</h1>
		</div>
	</div>

	<div data-role="page" id="allDucks">
		<div data-role="header" id="duckListHeader">
			<h1>Bongatut sorsat!</h1>
		</div>
		<table data-role="main" id="tiedotTaulu" class="ui-content ui-body-a">
		<thead>
				<tr>
					<th>Sorsalaji:</th>
					<th>Kuvaus:</th>
					<th>Päiväys:</th>	
					<th>Määrä:</th>	
					<!--<th>Sijainti:</th>		-->			
				</tr>
		</thead>
					<tbody>					
					</tbody>
		</table>
		<p>
			<input type="button" id="back" class="ui-button" value="Takaisin">
		</p>
		<div data-role="footer" id="duckListFooter">
			<h1>Sorsasovellus</h1>
		</div>
		
	</div> 
	<script type="text/javascript" src="cordova.js"></script> <!-- mahdollistaa laitteen ominaisuuksien käytön -->	
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCnWUWYNgyyqDFtJdry3A2R_fpoTt1eT7Y"></script>	
	<script>
	
			
			//Laitetaan kaksi jarrua päälle. 
		var deviceNotReady = $.Deferred(); //jarru_1=True
		var pageNotReady = $.Deferred(); //jarru_2=True	
		
		//Kun molemmat jarrut on avattu aloitamme laitteen koordinaattien etsimisen (Käytä Firefoxia)
		$.when(deviceNotReady, pageNotReady).done(pageReady);
		
		//Lisätään tapahtumankuuntelija tapahtumalle "onDeviceReady"
		document.addEventListener("deviceReady", onDeviceReady, false);
		function onDeviceReady() {			
			deviceNotReady.resolve();	//jarru_1=False				
		}	
		
		$(document).on("pagecontainershow", function( event, ui ) {	//Mikä tahansa sivu näytetään.
			var toPage = ui.toPage[0].id; //Mikä sivu on näytetty, palauttaa sivun id:n
			if(toPage=="addDuck"){			
				pageNotReady.resolve(); //jarru_2=False
				if(sessionStorage.name==undefined){
				document.location="#loginPage";
				}
				$("#date").val(haePaiva());
				$("#loggedIn").html("Kirjautuneena <br>" + sessionStorage.name);	
			} else if(toPage=="allDucks"){
				pageNotReady.resolve();
				if(sessionStorage.name==undefined){
				document.location="#loginPage";
				}
				haeTiedot();
				
			}	
		});
		
		function haeTiedot(){
			$("#tiedotTaulu tbody").html("");
			$.getJSON("http://proto387.haaga-helia.fi/~a1602812/backend/haeSorsat.php", function(result){
				$.each(result, function(i, field) {
				$("#tiedotTaulu tbody").append
				("<tr><td>"
				+field.species
				+"</td><td>"	
				+field.description
				+"</td><td>"
				+field.date
				+"</td><td>"
				+field.count
				//+"</td><td>"
				//+field.location
				+"</td></tr>");		
				});
			});
		} 
		
		function pageReady() {
		
			navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, { timeout: 20000 });
			function onLocationSuccess(position) {						
				makeMap(position.coords.latitude, position.coords.longitude);					
			}
			function onLocationError() {				
				console.log("Paikannus ei onnistu");
			}
		}
		
		function makeMap(lat, lon) {				
			var place = new google.maps.LatLng(lat, lon);			
			var myOptions = {
				zoom:15,
				center: place
			};
			var mapMap = new google.maps.Map(document.getElementById("mapLocation"), myOptions);	//tai $("#mapLocation")[0], myOptions	
			var marker = new google.maps.Marker({
				position: place,
				map: mapMap,
				title: "Olet tässä"
			})			
		}
		
		$("#login").on("tap", function() {		
			if($("#username").val().length>0&&$("#pwd").val().length>0){			
				$.ajax({
					type: 'POST',
					data: $("#loginForm").serialize(),
					url: 'http://proto387.haaga-helia.fi/~a1602812/backend/selectLogin.php',
					success: function(data){	
						console.log("1"+data);
						var values = JSON.parse(data);	
						if(values.length>0){
							console.log(values[0].name);
							sessionStorage.name=values[0].name;							
							document.location="#addDuck";
						}else{
							alert("Käyttäjätunnus tai salasana on väärä!")
							console.log("Käyttäjää ei tunnisteta.")
							document.location="#loginPage";
						}						
					},
					error: function(){	
						console.log(2);											
					}
				});
			} else {
				alert("Kentät eivät voi olla tyhjiä")
			}
		}); 

		$("#add").on("tap", function() {
			//console.log($("#species").val + " " +$("#description").val());
			
			if($("#species").val().length>0&&$("#description").val().length>0){
			
					$.ajax({
							type: 'POST',
							data: $("#lisaaLomake").serialize(),
							url: 'http://proto387.haaga-helia.fi/~a1602812/backend/lisaaSorsa.php',
							success: function(data){				
								document.location="#allDucks";
			document.getElementById("lisaaLomake").reset();
							},
							error: function(){
									haeTiedot();
			document.getElementById("lisaaLomake").reset();
							}
						
					});
						alert("Havainto lisätty!");
			} else {
				alert("Syötä ainakin laji sekä kuvaus!")
			}
		});
		
		$("#showDucks").on("tap", function() {
			document.location="#allDucks";
			//haeTiedot();//$("#emptyList").prop("disabled", true);
		});
		
		$("#back").on("tap", function() {
			document.location="#addDuck";
		});
		/*$("#add").on("tap", function() {
			var species = $("#species").val();
			var description = $("#description").val();
			var date = $("#day").val(haePaiva());
			var count = $("#count").val();
			if(species!=""){
				$("#duckList").append("<li class='delete' data-icon='delete'><a href='#'>" + species + ", " + description + ", " + day + ", " + count +" </a></li>");
				$("#duckList").listview("refresh");
				$("#species").val("");
				$("#description").val("");
				$("#day").val(haePaiva());
				$("#count").val("");
				//$("#tyhjennaLista").attr("disabled", false);  //tai
				$("#emptyList").prop("disabled", false);

			}
		});
	 */

		/*$.ajax({
					type: 'POST',
					data: $("#loginForm").serialize(),
					url: 'http://proto387.haaga-helia.fi/~a1602812/backend/locations.html',
					success: function(data){
						var locations=[];
						var places = JSON.parse(data);						
						for(var i=0;i<places.length;i++){
							var place={
							"lat" : parseFloat(places[i].lat),
							"lng" : parseFloat(places[i].lng)
							};							
							locations.push(place);
						}	
						var markers = locations.map(function(location, i) {
						return new google.maps.Marker({
							position: location,
							map: mapMap,
							title: "paikka_"+i,	
							//label: laskeEtaisyys(new google.maps.LatLng(location)) + " km"
						});				
						});	
					},
					error: function(){	
						console.log(2);											
					}
		});	*/			

		

		/*var poistettava;
		$(document).on("tap", ".delete", function(event) {
			poistettava = $(this);	//Palauttaa tapahtuman käynnistäneen objektin
			//Objektin ominaisuuksien ja arvojen läpikäynti (ei tarvita tässä tapauksessa, vain esimerkkinä)

			var obj = $(this);  //.context -pääsee sisälle objektin arvoihin
			for(var key in obj) {
				console.log('key: ' + key + '\n' + 'value: ' + obj[key]);
			}

			$("#poistoTxt").text("Vahvista poisto: " + poistettava.text().split(",")[0] + "?");
			event.preventDefault(); //Chrome sulkee popupin heti (bugi?). Estetään seuraavan tapahtuman suorittaminen.
			$("#popup_vahvistus").popup("open");
		});

		$("#vahvistaPoisto").on("tap", function() {
			poistettava.remove();
			if ($("#duckList li").size() < 1) {
				$("#emptyList").prop("disabled", true);
			}
			$("#popup_vahvistus").popup("close");
		}); */ 

		function haePaiva(){
			var dVal = new Date();
			var d = dVal.getDate();
			var m = dVal.getMonth()+1;
			var y = dVal.getFullYear();
			if(d<10){
				d="0"+d;
			}
			if(m<10){
				m="0"+m;
			}
			return d + "." + m + "." + y;
 		}
	
	</script>
</body>

</html>