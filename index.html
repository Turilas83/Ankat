<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="msapplication-tap-highlight" content="no" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
	<meta http-equiv="Content-Security-Policy" content="
			default-src 'self' 'unsafe-inline'  
https://mts.googleapis.com https://maps.googleapis.com 
https://maps.gstatic.com ws://10.35.15.254:3000/ http://code.jquery.com 
https://code.jquery.com https://csi.gstatic.com  https://ssl.gstatic.com gap: data: blob: filesystem: ; 
	" />
	
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">
	<script src="https://code.jquery.com/jquery-2.1.4.js" integrity="sha256-siFczlgw4jULnUICcdm9gjQPZkw/YPDqhQ9+nAOScE4="	crossorigin="anonymous"></script>
	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
   <link rel="stylesheet" type="text/css" href="css/index.css">
	<title>Ankkasovellus</title>
</head>
<body>

	<div data-role="page" id="loginPage">
		<div data-role="header" id="head">
			<h1>Kirjautuminen</h1>
		</div>

		<div data-role="main" class="ui-content ui-body-a">
		<div class="paiva"></div>
			<p>
			<label for="name">Nimi:</label>
			<input type="text" name="username" id="username">
			</p>
			<p>

			<label for="pwd">Salasana:</label>

			<input type="password" name="pwd" id="pwd">
			</p>
			<p>
			<button class="ui-btn ui-btn-inline ui-corner-all" id="login">Kirjaudu</button>
			</p>
		</div>

		<div data-role="footer" id="loginFooter">
			<h1>Ankkasovellus</h1>
			
		</div>
	</div>

	<div data-role="page" id="addDuck">
		<div data-role="header" id="addDuckHead">
			<h1>Havainto</h1>
		</div>
		
		<div data-role="main" class="ui-content ui-body-a">
			
      <p>
        <label for="species">Ankkalaji:</label>
		    <input type="text" name="species" id="species">
			
      </p>
      <p>
        <label for="description">Kuvaus:</label>
			<input type="text" name="description" id="description">
      </p>
      <p>
			<label for="date">Päivä:<div class="paiva"></div></label>
			
      </p>
      <p>
        <label for="count">Määrä:</label>
        <input type="number" name="count" id="count">
      </p>
      <p>
        <label for="location">Sijainti:</label>
			<div id="mapLocation" style="height:300px"></div> 
      </p>
		<hr>
		<p>
			<button class="ui-btn ui-btn-inline ui-corner-all" id="add">Lisää ankka havainto listaan</button>
			<button class="ui-btn ui-btn-inline ui-corner-all" id="emptyList" disabled>Tyhjennä lista</button>
		</p>
		<hr>
		<p>
			<ul data-role="listview" id="duckList" data-inset="true"></ul>
		</p>
   		</div>
		<div data-role="popup" id="popup_vahvistus">
			<div data-role="content">
				<h3 id="poistoTxt"></h3>
				<a class="ui-btn ui-corner-all" data-rel="back">Peruuta</a>
				<a class="ui-btn ui-corner-all" id="vahvistaPoisto" >Vahvista</a>
			</div>
		</div>
		<div data-role="footer" id="addDuckFooter">
			<h1>Ankkasovellus</h1>
		</div>
	</div>

	<div data-role="page" id="duckList">
		<div data-role="header">
			<h1>Bongaamasi ankat!</h1>
		</div>
		<div data-role="main" class="ui-content ui-body-a">
			<p></p>
		</div>
		<div data-role="footer">
			<h1>Ankkasovellus</h1>
		</div>
	</div>
	<script type="text/javascript" src="cordova.js"></script> <!-- mahdollistaa laitteen ominaisuuksien käytön -->	
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCnWUWYNgyyqDFtJdry3A2R_fpoTt1eT7Y"></script>
	<script>
	
		
		$(document).one("pagebeforecreate", function () { //Ennen minkä tahansa sivun luomista, tehdään kerran (.one)
				$(".paiva").text(haePaiva());

		});
		
		$(document).on("pagecreate", "#loginPage", function() { 	//Sivun luonti, tehdään kerran
					$(".paiva").text(haePaiva());
					
		});

		$(document).on("pagecreate", "#addDuck", function() {		//Sivun luonti, tehdään kerran
				$(".paiva").text(haePaiva());
					
		});
		
		$(document).on("pagecreate", "#duckList", function() { 	//Sivun luonti, tehdään kerran

		});

		$(document).on("pagecontainerbeforeshow", function( event, ui ) {	//Ennen minkä tahansa sivun näyttämistä. (pagebeforeshow is deprecated)
			var toPage = ui.toPage[0].id; //Mille sivulle ollaan menossa, palauttaa sivun id:n
			
			if(toPage=="loginPage"){
				$(".paiva");
						
			}else if(toPage=="addDuck"){
				$(".paiva");			
			}
		});
			
			//Laitetaan kaksi jarrua päälle. 
		var deviceNotReady = $.Deferred(); //jarru_1=True
		var pageNotReady = $.Deferred(); //jarru_2=True	
		
		//Kun molemmat jarrut on avattu aloitamme laitteen koordinaattien etsimisen (Käytä Firefoxia)
		$.when(deviceNotReady, pageNotReady).done(pageReady);
		
		//Lisätään tapahtumankuuntelija tapahtumalle "onDeviceReady"
		document.addEventListener("deviceReady", onDeviceReady, false);
		function onDeviceReady() {			
			deviceNotReady.resolve();	//jarru_1=False				
		}	
		
			$(document).on("pagecontainershow", function( event, ui ) {	//Mikä tahansa sivu näytetään.
			var toPage = ui.toPage[0].id; //Mikä sivu on näytetty, palauttaa sivun id:n
			if(toPage=="addDuck"){			
				pageNotReady.resolve(); //jarru_2=False
			}	
		});
		
		function pageReady() {
		
			navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, { timeout: 20000 });
			function onLocationSuccess(position) {						
				makeMap(position.coords.latitude, position.coords.longitude);					
			}
			function onLocationError() {				
				console.log("Paikannus ei onnistu");
			}
		}
		function makeMap(lat, lon) {				
			var place = new google.maps.LatLng(lat, lon);			
			var myOptions = {
				zoom:15,
				center: place
			};
			var mapMap = new google.maps.Map(document.getElementById("mapLocation"), myOptions);	//tai $("#mapLocation")[0], myOptions	
			var marker = new google.maps.Marker({
				position: place,
				map: mapMap,
				title: "Olet tässä"
			})				
		}

		$("#add").on("tap", function() {
			var species = $("#species").val();
			var description = $("#description").val();
			var paiva = $(".paiva");
			var count = $("#count").val();
			if(species!=""){
				$("#duckList").append("<li class='delete' data-icon='delete'><a href='#'>" + species + ", " + description + ", " + paiva + ", " + count +" </a></li>");
				$("#duckList").listview("refresh");
				$("#species").val("");
				$("#description").val("");
				$(".paiva");
				$("#count").val("");
				//$("#tyhjennaLista").attr("disabled", false);  //tai
				$("#emptyList").prop("disabled", false);

			}
		});
		$("#login").on("tap", function() {
			var username = $("#username").val();
			var pwd = $ ("#pwd").val();
			if(username == "Mikko" && pwd == "okkim") {
				window.location.href = "#addDuck";
			} else {
				alert("Tunnus tai salasana väärä!").css("color", "red");
			}
		});

		$("#emptyList").on("tap", function() {
			$("#duckList").empty();
			$("#emptyList").prop("disabled", true);
		});

		var poistettava;
		$(document).on("tap", ".delete", function(event) {
			poistettava = $(this);	//Palauttaa tapahtuman käynnistäneen objektin
			//Objektin ominaisuuksien ja arvojen läpikäynti (ei tarvita tässä tapauksessa, vain esimerkkinä)

			var obj = $(this);  //.context -pääsee sisälle objektin arvoihin
			for(var key in obj) {
				console.log('key: ' + key + '\n' + 'value: ' + obj[key]);
			}

			$("#poistoTxt").text("Vahvista poisto: " + poistettava.text().split(",")[0] + "?");
			event.preventDefault(); //Chrome sulkee popupin heti (bugi?). Estetään seuraavan tapahtuman suorittaminen.
			$("#popup_vahvistus").popup("open");
		});

		$("#vahvistaPoisto").on("tap", function() {
			poistettava.remove();
			if ($("#duckList li").size() < 1) {
				$("#emptyList").prop("disabled", true);
			}
			$("#popup_vahvistus").popup("close");
		});

		function haePaiva(){
			var dVal = new Date();
			var d = dVal.getDate();
			var m = dVal.getMonth()+1;
			var y = dVal.getFullYear();
			if(d<10){
				d="0"+d;
			}
			if(m<10){
				m="0"+m;
			}
			return d + "." + m + "." + y;
 		}
	
	</script>
</body>

</html>